apiVersion: v1
data:
  FACEBOOK--APPID: WW91cl9GYWNlYm9va19BcHBJZA==
  FACEBOOK--APPSECRET: WW91cl9GYWNlYm9va19BcHBTZWNyZXQ=
  GOOGLE--CLIENTID: WW91cl9Hb29nbGVfQ2xpZW50SWQ=
  GOOGLE--CLIENTSECRET: WW91cl9Hb29nbGVfQ2xpZW50X1NlY3JldA==
  IDENTITY--CONNECTIONSTRING: aWRlbnRpdHktZGI=
kind: Secret
metadata:
  name: identity-api-secrets
type: Opaque
---
apiVersion: v1
data:
  JWT__SECRET: QnlZTTAwME9MbE1RRzZWVlZwMU9IN1h6eXI3Z0h1dzFxdlVDNWRjR3QzU05N
  JWT__VALIDAUDIENCE: WW91cl9KV1RfVmFsaWRhdWRpZW5jZQo=
  JWT__VALIDISSUER: WW91cl9KV1RfVmFsaWRJc3N1ZXIK
kind: Secret
metadata:
  name: jwt-secrets
type: Opaque
---
apiVersion: v1
data:
  ORDER--CONNECTIONSTRING: Y2hhdC1kYg==
kind: Secret
metadata:
  name: order-api-secrets
type: Opaque
---
apiVersion: v1
data:
  RABBITMQ--HOSTNAME: cmFiYml0bXEuZGVmYXVsdC5zdmMuY2x1c3Rlci5sb2NhbA==
  RABBITMQ--PASSWORD: Z3Vlc3Q=
  RABBITMQ--PORT: NTY3Mg==
  RABBITMQ--USERNAME: Z3Vlc3Q=
kind: Secret
metadata:
  name: rabbitmq-secrets
type: Opaque
---
apiVersion: v1
kind: Service
metadata:
  name: frontend
spec:
  ports:
  - port: 80
    protocol: TCP
    targetPort: 80
  selector:
    app: frontend
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: gateway
spec:
  ports:
  - port: 8000
    targetPort: 80
  selector:
    app: gateway
  type: NodePort
---
apiVersion: v1
kind: Service
metadata:
  name: identity-api
spec:
  ports:
  - port: 80
    protocol: TCP
    targetPort: 5000
  selector:
    app: identity-api
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: order-api
spec:
  ports:
  - port: 80
    protocol: TCP
    targetPort: 5000
  selector:
    app: order-api
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
spec:
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
      - image: microservice_demo/frontend:latest
        name: frontend
        ports:
        - containerPort: 80
        resources:
          limits:
            cpu: 500m
            memory: 128Mi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gateway
spec:
  selector:
    matchLabels:
      app: gateway
  template:
    metadata:
      labels:
        app: gateway
    spec:
      containers:
      - image: envoyproxy/envoy:v1.20.2
        name: gateway
        ports:
        - containerPort: 80
          name: http
        - containerPort: 9901
          name: envoy-admin
        resources:
          limits:
            cpu: 500m
            memory: 128Mi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: identity-api
spec:
  selector:
    matchLabels:
      app: identity-api
  template:
    metadata:
      labels:
        app: identity-api
    spec:
      containers:
      - image: microservice_demo/identity-api:latest
        imagePullPolicy: IfNotPresent
        name: identity-api
        ports:
        - containerPort: 80
        resources:
          limits:
            cpu: 1000m
            memory: 128Mi
          requests:
            cpu: 500m
            memory: 128Mi
        volumeMounts:
        - mountPath: /secrets
          name: identity-api-secrets
          readOnly: false
        - mountPath: /secrets
          name: rabbitmq-secrets
          readOnly: false
        - mountPath: /secrets
          name: jwt-secrets
          readOnly: false
      volumes:
      - name: identity-api-secrets
        secret:
          secretName: identity-api-secrets
      - name: rabbitmq-secrets
        secret:
          secretName: rabbitmq-secrets
      - name: jwt-secrets
        secret:
          secretName: jwt-secrets
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: order-api
spec:
  selector:
    matchLabels:
      app: order-api
  template:
    metadata:
      labels:
        app: order-api
    spec:
      containers:
      - image: microservice_demo/order-api:latest
        imagePullPolicy: IfNotPresent
        name: order-api
        ports:
        - containerPort: 80
        resources:
          limits:
            cpu: 1000m
            memory: 128Mi
          requests:
            cpu: 500m
            memory: 128Mi
        volumeMounts:
        - mountPath: /secrets
          name: secrets
          readOnly: true
      volumes:
      - name: secrets
        projected:
          sources:
          - secret:
              name: order-api-secrets
          - secret:
              name: rabbitmq-secrets
          - secret:
              name: jwt-secrets
---
apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  name: rabbitmq
spec:
  override:
    statefulSet:
      spec:
        template:
          spec:
            containers: []
            initContainers:
            - name: setup-container
              securityContext: {}
            securityContext: {}
  replicas: 1
